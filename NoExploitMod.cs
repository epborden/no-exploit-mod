using BepInEx;
using BepInEx.Logging;
using HarmonyLib;
using System.Collections.Generic;

namespace NoExploitMod {
    [BepInPlugin(PLUGIN_GUID, PLUGIN_NAME, PLUGIN_VERSION)]
    [BepInProcess("valheim.exe")]
    [HarmonyPatch]
    public class NoExploitMod : BaseUnityPlugin {
        private const string PLUGIN_GUID = "com.evanborden.noexploitmod";
        private const string PLUGIN_NAME = "Glitch Fix Mod";
        private const string PLUGIN_VERSION = "1.0.0";

        private readonly Harmony harmony = new Harmony(PLUGIN_GUID);

        private static ManualLogSource logger = BepInEx.Logging.Logger.CreateLogSource("NoExploitMod");

        private void Awake() {
            logger.LogInfo("Patching common Valheim advancement exploits :).");
            harmony.PatchAll();
        }

        [HarmonyPatch(typeof(MineRock5), "DamageArea")]
        [HarmonyPrefix]
        private static bool MineRock5DamageAreaPatch(ref bool __result, ref int ___m_minToolTier, HitData hit) {
            Character attacker = hit.GetAttacker();

            if (attacker != null) {
                if (attacker.m_name == "Human" && hit.m_damage.m_blunt > 0f && hit.m_toolTier < ___m_minToolTier) {
                    __result = false;
                    return false;
                }

                if (attacker.m_name == "$enemy_troll") {
                    __result = false;
                    return false;
                }
            }

            return true;
        }

        [HarmonyPatch(typeof(Location), "Awake")]
        [HarmonyPrefix]
        private static void LocationAwakePatch(ref List<Location> ___m_allLocations) {
            foreach (Location location in ___m_allLocations) {
                string name = location.gameObject.name;

                if (name == "SunkenCrypt4" || name == "SunkenCrypt4(Clone)") {
                    location.m_noBuild = true;
                }
            }
        }
    }
}
